<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clinic-flow (ë¦¬ì…‰ìš©)</title>
  <style>
    :root{
      --bg:#fafafa; --card:#ffffff; --border:#e5e7eb;
      --fg:#0f172a; --muted:#64748b;
      --brand:#2b5fa3; --brand-ink:#102339;
      --btn:#f1f5f9; --btn-ink:#111827; --btn-hover:#e2e8f0;
      --pill:#1f2937;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}

    .topbar{position:sticky;top:0;z-index:60;display:flex;justify-content:flex-end;align-items:center;gap:6px;padding:6px 10px;background:rgba(250,250,250,.85);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border);font-size:12px}
    .topbar button{border:0;border-radius:8px;padding:6px 8px;background:var(--btn);color:var(--btn-ink);cursor:pointer}
    .topbar button:hover{background:var(--btn-hover)}
    .topbar .ok{background:var(--brand);color:#fff}
    .topbar .ok:hover{filter:brightness(.95)}
    .whoami{opacity:.7}

    main{padding:16px}
    h1{margin:6px 0 12px;display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .logo{width:28px;height:28px;border-radius:6px;object-fit:cover}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 4px 2px}

    .inputs-wrap{display:grid;grid-template-columns:120px 120px 100px;gap:12px;align-items:end}
    .inputs-wrap input{width:100%;min-width:0;padding:8px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:15px;background:#fff;box-sizing:border-box}
    #addCase{width:100%;max-width:unset;white-space:nowrap;box-sizing:border-box}

    .btn{cursor:pointer;border:1px solid #d1d5db;border-radius:10px;padding:12px 14px;font-weight:700;background:var(--btn);color:var(--btn-ink);white-space:nowrap;transition:.15s}
    .btn:hover{background:var(--btn-hover)}
    .btn.ok{border-color:transparent;background:var(--brand);color:#fff}
    .btn.ok:hover{filter:brightness(.95)}
    .btn.dark{border-color:#111827;background:#111827;color:#fff}

    .small{font-size:12px;opacity:.75;margin-top:24px}

    .toolbar{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto}
    .toolbar + .toolbar{margin-top:8px}
    .toolbar button{white-space:nowrap}

    .memo-wrap{display:flex;gap:8px;align-items:center;margin-top:16px}
    .memo-wrap input{flex:1 1 auto;min-width:120px;padding:8px 10px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:14px}

    .list{display:grid;grid-template-columns:1fr;gap:6px;margin-top:8px}
    .line{display:grid;grid-template-columns:1.4fr .8fr .6fr;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .name{font-weight:800;text-align:left}
    .state{font-weight:900;text-align:center}
    .updated{font-size:12px;opacity:.7;text-align:right;word-break:keep-all}
    .line.select{outline:3px solid var(--brand);outline-offset:0}
    .line.calling{outline:3px solid rgba(220,38,38,.6);animation:callblink 1.1s linear infinite}
    @keyframes callblink{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.8)}}

    .statusbar{position:fixed;bottom:8px;left:8px;right:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;z-index:55}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:var(--pill);color:#fff}
    .pill.ok{background:#16a34a}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b}

    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700;white-space:pre-wrap}
    .errbox.show{display:block}

    /* ì‘ì€ ë°°ë„ˆ ì•Œë¦¼ (ê¸°ì¡´ ì½œìš”ì²­ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©) */
    .alert{display:none;margin:10px 0;padding:14px 16px;border-radius:12px;border:2px solid #ef4444;background:#fef2f2;color:#991b1b;font-weight:900}
    .alert.show{display:block;animation:pop .5s}
    @keyframes pop{from{transform:scale(.98)}to{transform:scale(1)}}

    /* í° íŒì—…(ê¸°ì¡´) */
    .overlay{position:fixed;inset:0;z-index:80;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(4px)}
    .overlay.show{display:flex}
    .modal{width:min(720px,92vw);background:#fff;color:#0f172a;border-radius:16px;border:3px solid #ef4444;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:22px 22px 18px;text-align:center;animation:flash .9s ease-in-out 1}
    @keyframes flash{0%{transform:scale(.98)}100%{transform:scale(1)}}
    .modal h2{margin:0 0 6px;font-size:28px;font-weight:900}
    .who{font-size:40px;font-weight:900;margin:6px 0 2px}
    .hint{font-size:13px;color:#64748b;margin-bottom:14px}
    .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
    .actions .btn{padding:12px 16px;font-size:15px}
  </style>
</head>
<body>
  <div class="topbar">
    <span id="whoami" class="whoami"></span>
    <button id="loginBtn" class="ok">Googleë¡œ ë¡œê·¸ì¸</button>
    <button id="logoutBtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <main>
    <h1>
      <img class="logo" src="image-512.png" alt="BS Logo" /> Clinic-flow (ë¦¬ì…‰ìš©)
    </h1>

    <div id="err" class="errbox"></div>

    <!-- ê¸°ì¡´ ì½œìš”ì²­ ë°°ë„ˆ -->
    <div id="alertBox" class="alert">ğŸ“£ ì²˜ì¹˜ì‹¤ì—ì„œ <span id="alertWho"></span> ì½œ ìš”ì²­!
      <button id="ack" class="btn ok" style="margin-left:8px">ì²˜ë¦¬ì™„ë£Œ</button>
    </div>

    <!-- â–¶ ì „ë‹¬ì™„ë£Œ ë°°ë„ˆ (ë””ìŠ¤í”Œë ˆì´ê°€ í™•ì¸í–ˆì„ ë•Œ) -->
    <div id="relayBox" class="alert" style="display:none"></div>

    <!-- í° íŒì—…(ê¸°ì¡´) -->
    <div id="bigOverlay" class="overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true">
        <h2 id="modalTitle">ğŸ“£ ì½œ ìš”ì²­</h2>
        <div id="bigWho" class="who"></div>
        <div class="hint">â€œì²˜ë¦¬ì™„ë£Œâ€ë¥¼ ëˆ„ë¥´ë©´ ìƒíƒœê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</div>
        <div class="actions">
          <button id="bigAck" class="btn ok">ì²˜ë¦¬ì™„ë£Œ</button>
          <button id="bigClose" class="btn">ë‹«ê¸°</button>
        </div>
      </div>
    </div>

    <div id="panel" style="display:none">
      <div class="card">
        <div class="inputs-wrap">
          <div><label>ê³ ì–‘ì´ ì´ë¦„</label><input id="patientName" type="text" placeholder="ì˜ˆ: ëƒ¥ëƒ¥ì´" /></div>
          <div><label>ë³´í˜¸ì ì´ë¦„</label><input id="guardianName" type="text" placeholder="ì˜ˆ: ê¹€ë•¡ë•¡" /></div>
          <button id="addCase" class="btn ok">í™˜ì ì¶”ê°€</button>
        </div>

        <div class="small">[í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ ì¤‘ ì„ íƒëœ í™˜ìì— ì ìš©ë©ë‹ˆë‹¤.]</div>
        <div class="toolbar" id="row1"></div>
        <div class="toolbar" id="row2"></div>
        <div class="toolbar" id="row3"></div>

        <div class="memo-wrap">
          <input id="memoInput" type="text" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" />
          <button id="memoSaveBtn" class="btn">ë©”ëª¨ ì €ì¥</button>
        </div>
      </div>

      <div class="card">
        <div class="list">
          <div class="line" style="background:#f8fafc">
            <div class="name">ì´ë¦„</div><div class="state">ìƒíƒœ</div><div class="updated">ì—…ë°ì´íŠ¸</div>
          </div>
          <div id="caseList" class="list"></div>
        </div>
      </div>
    </div>

    <div class="statusbar">
      <span id="conn" class="pill warn">ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
      <button id="selftest" class="pill">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </div>

    <audio id="bell" preload="auto">
      <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>
  </main>

  <script type="module">
    const errBox=document.getElementById('err');
    const showErr=(m)=>{console.error(m);errBox.textContent=m;errBox.classList.add('show')};
    const hideErr=()=>errBox.classList.remove('show');

    const relTime=(ts)=>{if(!ts)return "";const s=Math.floor((Date.now()-ts)/1000);
      if(s<60)return`${s}ì´ˆ ì „`;const m=Math.floor(s/60);if(m<60)return`${m}ë¶„ ì „`;
      const h=Math.floor(m/60);if(h<24)return`${h}ì‹œê°„ ì „`;const d=Math.floor(h/24);return`${d}ì¼ ì „`};
    const formatKTime=(ts)=>{if(!ts)return"";const d=new Date(ts);let h=d.getHours();const m=String(d.getMinutes()).padStart(2,'0');const ap=h<12?'ì˜¤ì „':'ì˜¤í›„';h=h%12||12;return `${ap} ${h}:${m}`};
    const renderUpdatedText=(ts)=> `${relTime(ts)}\n(${formatKTime(ts)})`;

    window.addEventListener('error', e=> showErr('ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬: '+(e.message||'unknown')));

    try{
      const { initializeApp }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, addDoc, onSnapshot, doc, runTransaction, query, orderBy, setDoc, deleteDoc }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig={apiKey:"AIzaSyDh_LCBSgYZX1nnz3C-kGzjVtIwI3zf_8g",authDomain:"clinic-flow-c26f6.firebaseapp.com",projectId:"clinic-flow-c26f6"};
      const app=initializeApp(firebaseConfig);
      const db=getFirestore(app);
      const auth=getAuth(app);
      await setPersistence(auth, browserLocalPersistence);
      const provider=new GoogleAuthProvider();

      const loginBtn=document.getElementById('loginBtn');
      const logoutBtn=document.getElementById('logoutBtn');
      const whoami=document.getElementById('whoami');
      const panel=document.getElementById('panel');
      const conn=document.getElementById('conn');
      const selftest=document.getElementById('selftest');

      loginBtn.onclick=async()=>{try{await signInWithPopup(auth,provider);}catch(e){showErr(e.message)}};
      logoutBtn.onclick=async()=>{await signOut(auth)};

      onAuthStateChanged(auth,(user)=>{
        if(user){whoami.textContent=user.email;panel.style.display="";logoutBtn.style.display="";loginBtn.style.display="none";}
        else{whoami.textContent="";panel.style.display="none";logoutBtn.style.display="none";loginBtn.style.display=""; }
      });

      // ì‹ ê·œ í™˜ì
      const patientName=document.getElementById('patientName');
      const guardianName=document.getElementById('guardianName');
      const addCaseBtn=document.getElementById('addCase');
      addCaseBtn.onclick=async()=>{
        const pn=patientName.value.trim(); const gn=guardianName.value.trim();
        if(!pn && !gn) return showErr("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        try{
          const ref=await addDoc(collection(db,"cases"),{
            patientName:pn, guardianName:gn,
            location:"ì›ë‚´",
            createdAt:Date.now(), updatedAt:Date.now(),
            version:1, callRequested:false, memo:"",
            ackRequestedAt:0, ackConfirmed:false
          });
          patientName.value=""; guardianName.value=""; hideErr();
          selectedId=ref.id;
        }catch(e){showErr("í™˜ì ì¶”ê°€ ì‹¤íŒ¨: "+e.message)}
      };

      // ìƒíƒœ ë²„íŠ¼ êµ¬ì„±
      const row1=document.getElementById('row1');
      const row2=document.getElementById('row2');
      const row3=document.getElementById('row3');
      const mk=(t,fn,cls="btn")=>{const b=document.createElement('button');b.className=cls;b.textContent=t;b.onclick=fn;if(t==="ìƒë‹´ëŒ€ê¸°ì¤‘"||t==="ë©´íšŒëŒ€ê¸°ì¤‘"){b.style.color="#dc2626";b.style.fontWeight="900"}return b}

      const ROW1=["ìƒë‹´ëŒ€ê¸°ì¤‘","ë©´íšŒëŒ€ê¸°ì¤‘","ì›ë‚´","ë¼ìš´ì§€","ì™¸ì¶œ"];
      const ROW2=["ë¼ìš´ì§€ì½œì™„ë£Œ","ì™¸ì¶œì½œì™„ë£Œ","ê·€ê°€","ìˆ˜ë‚©í›„ë¯¸ê·€ê°€"];
      const ROW3=["1ì§„ë£Œì‹¤","2ì§„ë£Œì‹¤","3ì§„ë£Œì‹¤","4ì§„ë£Œì‹¤","ì‚­ì œ"];
      ROW1.forEach(s=>row1.appendChild(mk(s,()=>applyGlobalState(s))));
      ROW2.forEach(s=>row2.appendChild(mk(s,()=>applyGlobalState(s))));
      ROW3.forEach(s=>{ if(s==="ì‚­ì œ")row3.appendChild(mk(s,onDelete,"btn dark")); else row3.appendChild(mk(s,()=>applyGlobalState(s))); });

      // ë©”ëª¨
      const memoInput=document.getElementById('memoInput');
      const memoSaveBtn=document.getElementById('memoSaveBtn');
      memoSaveBtn.onclick=async()=>{ if(!selectedId) return showErr("ë¨¼ì € í™˜ìë¥¼ ì„ íƒí•˜ì„¸ìš”."); await updateCase(selectedId,{memo:(memoInput.value||"").trim()}); };

      let selectedId=null;
      const caseList=document.getElementById('caseList');

      function prettyName(d,id){return (d.patientName||d.guardianName)?(d.patientName&&d.guardianName?`${d.patientName}(${d.guardianName})`:(d.patientName||d.guardianName)):id}
      function colorFor(s){
        if(s==="ìƒë‹´ëŒ€ê¸°ì¤‘"||s==="ë©´íšŒëŒ€ê¸°ì¤‘")return"#dc2626";
        if(s==="ì›ë‚´"||s==="ë¼ìš´ì§€")return"#d97706";
        if(s==="ì™¸ì¶œ")return"#0284c7";
        if(s==="ë¼ìš´ì§€ì½œì™„ë£Œ"||s==="ì™¸ì¶œì½œì™„ë£Œ")return"#16a34a";
        if(/^\s*[1-4]\s?ì§„ë£Œì‹¤$/.test(s||""))return"#2b5fa3";
        if(s==="ê·€ê°€"||s==="ìˆ˜ë‚©í›„ë¯¸ê·€ê°€")return"#64748b";
        return"";
      }

      function renderLine(id,d){
        const line=document.createElement('div');line.className='line';line.dataset.id=id;
        const name=document.createElement('div');name.className='name';name.textContent=prettyName(d,id);
        if(d.memo && d.memo.trim()!==""){const m=document.createElement('span');m.textContent="ğŸ“";m.style.marginLeft="8px";m.style.fontSize="12px";m.title=d.memo.trim();name.appendChild(m);}
        const state=document.createElement('div');state.className='state';state.textContent=d.location||''; const c=colorFor(d.location||""); if(c)state.style.color=c;
        const upd=document.createElement('div');upd.className='updated'; if(d.updatedAt){upd.dataset.ts=String(d.updatedAt);upd.innerHTML=renderUpdatedText(d.updatedAt)} else upd.textContent='';
        line.appendChild(name);line.appendChild(state);line.appendChild(upd);
        line.onclick=()=>{selectedId=id;[...caseList.children].forEach(el=>el.classList.remove('select'));line.classList.add('select');memoInput.value=d.memo||""};
        if(d.callRequested) line.classList.add('calling');
        return line;
      }

      async function updateCase(id,data){
        try{
          await runTransaction(db,async(tx)=>{
            const ref=doc(db,"cases",id);
            const snap=await tx.get(ref);
            const prev=snap.exists()?snap.data():{version:0};
            tx.set(ref,{...data,updatedAt:Date.now(),version:(prev.version||0)+1},{merge:true});
          });
          hideErr();
        }catch(e){showErr("ì €ì¥ ì‹¤íŒ¨: "+e.message)}
      }

      async function applyGlobalState(state){
        if(!selectedId){showErr("ë¨¼ì € í™˜ì í•œ ëª…ì„ ì„ íƒí•˜ì„¸ìš”.");return;}
        if(state==="ê·€ê°€"){const yes=confirm("ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œí• ê¹Œìš”? (ì˜ˆ: ë¬¸ì„œë¥¼ ì‚­ì œ / ì•„ë‹ˆì˜¤: ìƒíƒœë§Œ 'ê·€ê°€'ë¡œ í‘œì‹œ)"); if(yes){return onDelete();}}
        if(state==="ìƒë‹´ëŒ€ê¸°ì¤‘"||state==="ë©´íšŒëŒ€ê¸°ì¤‘"){
          await updateCase(selectedId,{location:state,callRequested:false,ackRequestedAt:Date.now(),ackConfirmed:false});
        }else{
          await updateCase(selectedId,{location:state,callRequested:false});
        }
      }

      async function onDelete(){
        if(!selectedId) return showErr("ë¨¼ì € í™˜ì í•œ ëª…ì„ ì„ íƒí•˜ì„¸ìš”.");
        const ok=confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)");
        if(!ok) return;
        try{ await deleteDoc(doc(db,"cases",selectedId)); selectedId=null; hideErr(); memoInput.value=""; }
        catch(e){ showErr("ì‚­ì œ ì‹¤íŒ¨: "+e.message); }
      }

      // ===== ì•Œë¦¼ UI =====
      const alertBox=document.getElementById('alertBox');
      const alertWho=document.getElementById('alertWho');
      const ackBtn=document.getElementById('ack');

      const bigOverlay=document.getElementById('bigOverlay');
      const modalTitle=document.getElementById('modalTitle');
      const bigWho=document.getElementById('bigWho');
      const bigAck=document.getElementById('bigAck');
      const bigClose=document.getElementById('bigClose');
      const bell=document.getElementById('bell');

      const relayBox=document.getElementById('relayBox');

      let lastAlertedId=null;
      let pendingReq=null;

      function resolveAckLocation(cur){ if(cur==="ì™¸ì¶œ")return"ì™¸ì¶œì½œì™„ë£Œ"; if(cur==="ë¼ìš´ì§€")return"ë¼ìš´ì§€ì½œì™„ë£Œ"; return"ë¼ìš´ì§€ì½œì™„ë£Œ"; }
      function showBigOverlay(name){ bigWho.textContent=name; bigOverlay.classList.add('show'); bigOverlay.setAttribute('aria-hidden','false'); }
      function hideBigOverlay(){ bigOverlay.classList.remove('show'); bigOverlay.setAttribute('aria-hidden','true'); }
      bigClose.onclick=hideBigOverlay;

      // ì‹¤ì‹œê°„ êµ¬ë…
      onSnapshot(query(collection(db,"cases"),orderBy("createdAt","desc")),(snap)=>{
        hideErr();
        caseList.innerHTML="";
        let firstId=null;
        let anyReq=null;

        // â–¶ ë””ìŠ¤í”Œë ˆì´ í™•ì¸ ì‹ í˜¸(ackConfirmed:true) ê°ì§€í–ˆëŠ”ì§€ ì¶”ì 
        let anyAck=null;

        snap.forEach(docu=>{
          const d=docu.data();
          const el=renderLine(docu.id,d);
          caseList.appendChild(el);
          if(!firstId) firstId=docu.id;

          if(docu.id===selectedId) { /* í˜„ì¬ ì„ íƒ ìœ ì§€ìš© */ }

          if(d.callRequested) anyReq={id:docu.id,d};

          // â˜…â˜…â˜… ë””ìŠ¤í”Œë ˆì´ íŒì—… 'í™•ì¸' í›„ ì‹ í˜¸ ê°ì§€ ì§€ì  â˜…â˜…â˜…
          if(d.ackConfirmed===true){
            anyAck={id:docu.id,d};
          }
        });

        // ìµœì´ˆ ìë™ ì„ íƒ ë³´ì •
        if(!selectedId && firstId){
          selectedId=firstId;
          const firstEl=caseList.querySelector(`[data-id="${firstId}"]`);
          if(firstEl) firstEl.classList.add('select');
        }
        if(selectedId){
          const selEl=caseList.querySelector(`[data-id="${selectedId}"]`);
          if(selEl){ [...caseList.children].forEach(el=>el.classList.remove('select')); selEl.classList.add('select'); }
        }

        // ì‘ì€ ë°°ë„ˆ: ì½œìš”ì²­ ìš°ì„ , ì—†ìœ¼ë©´ ì „ë‹¬ì™„ë£Œ ë°°ë„ˆ
        if(anyReq){
          alertWho.textContent=prettyName(anyReq.d,anyReq.id);
          alertBox.classList.add('show');
          relayBox.classList.remove('show');
        }else if(anyAck){
          const name=prettyName(anyAck.d,anyAck.id);
          relayBox.textContent=`ğŸ“£ '${name}' ëŒ€ê¸°ì¤‘ ì „ë‹¬ì™„ë£Œ`;
          relayBox.style.display="";
          relayBox.classList.add('show');
          alertBox.classList.remove('show');

          // ì‚¬ìš´ë“œ + ìë™ ìˆ¨ê¹€ + í”Œë˜ê·¸ ë¦¬ì…‹(false)  â†’ ì¤‘ë³µ ë°©ì§€
          try{ bell.currentTime=0; bell.play().catch(()=>{});}catch(e){}
          setTimeout(async()=>{
            relayBox.classList.remove('show');
            await updateCase(anyAck.id,{ackConfirmed:false});
          },1500);
        }else{
          alertBox.classList.remove('show');
          relayBox.classList.remove('show');
        }

        // í° íŒì—… + ì‚¬ìš´ë“œ: ì½œìš”ì²­ë§Œ ì‚¬ìš©(ê¸°ì¡´ ë™ì‘ ìœ ì§€)
        if(anyReq && anyReq.id!==lastAlertedId){
          pendingReq=anyReq;
          modalTitle.textContent='ğŸ“£ ì½œ ìš”ì²­';
          showBigOverlay(prettyName(anyReq.d,anyReq.id));
          try{ bell.currentTime=0; bell.play().catch(()=>{});}catch(e){}
          lastAlertedId=anyReq.id;
        }
        if(!anyReq){
          pendingReq=null; lastAlertedId=null; hideBigOverlay();
        }

        conn.textContent="ì—°ê²°ë¨"; conn.className="pill ok";
      },(e)=>{conn.textContent="ì—°ê²° ì˜¤ë¥˜";conn.className="pill err";showErr("ë¦¬ìŠ¤íŠ¸ êµ¬ë… ì‹¤íŒ¨: "+e.message);});

      // ì½œìš”ì²­ ì²˜ë¦¬ì™„ë£Œ(ê¸°ì¡´)
      async function acknowledge(req){
        if(!req) return;
        const d=req.d;
        const ns=resolveAckLocation(d.location||"");
        await updateCase(req.id,{callRequested:false,location:ns});
        hideBigOverlay();
      }
      ackBtn.onclick=()=>acknowledge(pendingReq);
      bigAck.onclick=()=>acknowledge(pendingReq);

      // ì—°ê²° í…ŒìŠ¤íŠ¸
      selftest.onclick=async()=>{
        try{ await setDoc(doc(db,"healthcheck","reception"),{ping:Date.now()},{merge:true});
          conn.textContent="ì—°ê²° ì •ìƒ"; conn.className="pill ok"; hideErr();
        }catch(e){ conn.textContent="ì—°ê²° ì˜¤ë¥˜"; conn.className="pill err"; showErr("ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: "+e.message); }
      };

    }catch(e){
      showErr("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: "+(e.message||e));
      const conn=document.getElementById('conn'); if(conn){conn.textContent="ì´ˆê¸°í™” ì˜¤ë¥˜";conn.className="pill err";}
    }
  </script>
</body>
</html>
