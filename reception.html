<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clinic-flow (리셉용)</title>
  <style>
    :root{
      --bg:#fafafa; --card:#ffffff; --border:#e5e7eb;
      --fg:#0f172a; --muted:#64748b;
      --brand:#2b5fa3; --brand-ink:#102339;
      --btn:#f1f5f9; --btn-ink:#111827; --btn-hover:#e2e8f0;
      --pill:#1f2937;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}

    .topbar{position:sticky;top:0;z-index:60;display:flex;justify-content:flex-end;align-items:center;gap:6px;padding:6px 10px;background:rgba(250,250,250,.85);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border);font-size:12px}
    .topbar button{border:0;border-radius:8px;padding:6px 8px;background:var(--btn);color:var(--btn-ink);cursor:pointer}
    .topbar button:hover{background:var(--btn-hover)}
    .topbar .ok{background:var(--brand);color:#fff}
    .topbar .ok:hover{filter:brightness(.95)}
    .whoami{opacity:.7}

    main{padding:16px}
    h1{margin:6px 0 12px;display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .logo{width:28px;height:28px;border-radius:6px;object-fit:cover}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 4px 2px}

    .inputs-wrap{display:grid;grid-template-columns:120px 120px 100px;gap:12px;align-items:end}
    .inputs-wrap input{width:100%;min-width:0;padding:8px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:15px;background:#fff;box-sizing:border-box}
    #addCase{width:100%;max-width:unset;white-space:nowrap;box-sizing:border-box}

    .btn{cursor:pointer;border:1px solid #d1d5db;border-radius:10px;padding:12px 14px;font-weight:700;background:var(--btn);color:var(--btn-ink);white-space:nowrap;transition:.15s}
    .btn:hover{background:var(--btn-hover)}
    .btn.ok{border-color:transparent;background:var(--brand);color:#fff}
    .btn.ok:hover{filter:brightness(.95)}
    .btn.dark{border-color:#111827;background:#111827;color:#fff}

    .small{font-size:12px;opacity:.75;margin-top:24px}

    .toolbar{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto}
    .toolbar + .toolbar{margin-top:8px}
    .toolbar button{white-space:nowrap}

    .memo-wrap{display:flex;gap:8px;align-items:center;margin-top:16px}
    .memo-wrap input{flex:1 1 auto;min-width:120px;padding:8px 10px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:14px}

    .list{display:grid;grid-template-columns:1fr;gap:6px;margin-top:8px}
    .line{display:grid;grid-template-columns:1.4fr .8fr .6fr;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .name{font-weight:800;text-align:left}
    .state{font-weight:900;text-align:center}
    .updated{font-size:12px;opacity:.7;text-align:right;word-break:keep-all}
    .line.select{outline:3px solid var(--brand);outline-offset:0}
    .line.calling{outline:3px solid rgba(220,38,38,.6);animation:callblink 1.1s linear infinite}
    @keyframes callblink{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.8)}}

    .statusbar{position:fixed;bottom:8px;left:8px;right:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;z-index:55}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;background:var(--pill);color:#fff}
    .pill.ok{background:#16a34a}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b}

    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700;white-space:pre-wrap}
    .errbox.show{display:block}

    /* 작은 배너 알림 (기존 콜요청 스타일 재사용) */
    .alert{display:none;margin:10px 0;padding:14px 16px;border-radius:12px;border:2px solid #ef4444;background:#fef2f2;color:#991b1b;font-weight:900}
    .alert.show{display:block;animation:pop .5s}
    @keyframes pop{from{transform:scale(.98)}to{transform:scale(1)}}

    /* 큰 팝업(기존) */
    .overlay{position:fixed;inset:0;z-index:80;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(4px)}
    .overlay.show{display:flex}
    .modal{width:min(720px,92vw);background:#fff;color:#0f172a;border-radius:16px;border:3px solid #ef4444;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:22px 22px 18px;text-align:center;animation:flash .9s ease-in-out 1}
    @keyframes flash{0%{transform:scale(.98)}100%{transform:scale(1)}}
    .modal h2{margin:0 0 6px;font-size:28px;font-weight:900}
    .who{font-size:40px;font-weight:900;margin:6px 0 2px}
    .hint{font-size:13px;color:#64748b;margin-bottom:14px}
    .actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
    .actions .btn{padding:12px 16px;font-size:15px}
  </style>
</head>
<body>
  <div class="topbar">
    <span id="whoami" class="whoami"></span>
    <button id="loginBtn" class="ok">Google로 로그인</button>
    <button id="logoutBtn" style="display:none">로그아웃</button>
  </div>

  <main>
    <h1>
      <img class="logo" src="image-512.png" alt="BS Logo" /> Clinic-flow (리셉용)
    </h1>

    <div id="err" class="errbox"></div>

    <!-- 기존 콜요청 배너 -->
    <div id="alertBox" class="alert">📣 처치실에서 <span id="alertWho"></span> 콜 요청!
      <button id="ack" class="btn ok" style="margin-left:8px">처리완료</button>
    </div>

    <!-- ▶ 전달완료 배너 (디스플레이가 확인했을 때) -->
    <div id="relayBox" class="alert" style="display:none"></div>

    <!-- 큰 팝업(기존) -->
    <div id="bigOverlay" class="overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true">
        <h2 id="modalTitle">📣 콜 요청</h2>
        <div id="bigWho" class="who"></div>
        <div class="hint">“처리완료”를 누르면 상태가 자동으로 업데이트됩니다.</div>
        <div class="actions">
          <button id="bigAck" class="btn ok">처리완료</button>
          <button id="bigClose" class="btn">닫기</button>
        </div>
      </div>
    </div>

    <div id="panel" style="display:none">
      <div class="card">
        <div class="inputs-wrap">
          <div><label>고양이 이름</label><input id="patientName" type="text" placeholder="예: 냥냥이" /></div>
          <div><label>보호자 이름</label><input id="guardianName" type="text" placeholder="예: 김땡땡" /></div>
          <button id="addCase" class="btn ok">환자 추가</button>
        </div>

        <div class="small">[하단 리스트 중 선택된 환자에 적용됩니다.]</div>
        <div class="toolbar" id="row1"></div>
        <div class="toolbar" id="row2"></div>
        <div class="toolbar" id="row3"></div>

        <div class="memo-wrap">
          <input id="memoInput" type="text" placeholder="간단한 메모를 입력하세요…" />
          <button id="memoSaveBtn" class="btn">메모 저장</button>
        </div>
      </div>

      <div class="card">
        <div class="list">
          <div class="line" style="background:#f8fafc">
            <div class="name">이름</div><div class="state">상태</div><div class="updated">업데이트</div>
          </div>
          <div id="caseList" class="list"></div>
        </div>
      </div>
    </div>

    <div class="statusbar">
      <span id="conn" class="pill warn">연결 확인 중…</span>
      <button id="selftest" class="pill">연결 테스트</button>
    </div>

    <audio id="bell" preload="auto">
      <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>
  </main>

  <script type="module">
    const errBox=document.getElementById('err');
    const showErr=(m)=>{console.error(m);errBox.textContent=m;errBox.classList.add('show')};
    const hideErr=()=>errBox.classList.remove('show');

    const relTime=(ts)=>{if(!ts)return "";const s=Math.floor((Date.now()-ts)/1000);
      if(s<60)return`${s}초 전`;const m=Math.floor(s/60);if(m<60)return`${m}분 전`;
      const h=Math.floor(m/60);if(h<24)return`${h}시간 전`;const d=Math.floor(h/24);return`${d}일 전`};
    const formatKTime=(ts)=>{if(!ts)return"";const d=new Date(ts);let h=d.getHours();const m=String(d.getMinutes()).padStart(2,'0');const ap=h<12?'오전':'오후';h=h%12||12;return `${ap} ${h}:${m}`};
    const renderUpdatedText=(ts)=> `${relTime(ts)}\n(${formatKTime(ts)})`;

    window.addEventListener('error', e=> showErr('스크립트 에러: '+(e.message||'unknown')));

    try{
      const { initializeApp }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, addDoc, onSnapshot, doc, runTransaction, query, orderBy, setDoc, deleteDoc }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig={apiKey:"AIzaSyDh_LCBSgYZX1nnz3C-kGzjVtIwI3zf_8g",authDomain:"clinic-flow-c26f6.firebaseapp.com",projectId:"clinic-flow-c26f6"};
      const app=initializeApp(firebaseConfig);
      const db=getFirestore(app);
      const auth=getAuth(app);
      await setPersistence(auth, browserLocalPersistence);
      const provider=new GoogleAuthProvider();

      const loginBtn=document.getElementById('loginBtn');
      const logoutBtn=document.getElementById('logoutBtn');
      const whoami=document.getElementById('whoami');
      const panel=document.getElementById('panel');
      const conn=document.getElementById('conn');
      const selftest=document.getElementById('selftest');

      loginBtn.onclick=async()=>{try{await signInWithPopup(auth,provider);}catch(e){showErr(e.message)}};
      logoutBtn.onclick=async()=>{await signOut(auth)};

      onAuthStateChanged(auth,(user)=>{
        if(user){whoami.textContent=user.email;panel.style.display="";logoutBtn.style.display="";loginBtn.style.display="none";}
        else{whoami.textContent="";panel.style.display="none";logoutBtn.style.display="none";loginBtn.style.display=""; }
      });

      // 신규 환자
      const patientName=document.getElementById('patientName');
      const guardianName=document.getElementById('guardianName');
      const addCaseBtn=document.getElementById('addCase');
      addCaseBtn.onclick=async()=>{
        const pn=patientName.value.trim(); const gn=guardianName.value.trim();
        if(!pn && !gn) return showErr("이름을 입력하세요.");
        try{
          const ref=await addDoc(collection(db,"cases"),{
            patientName:pn, guardianName:gn,
            location:"원내",
            createdAt:Date.now(), updatedAt:Date.now(),
            version:1, callRequested:false, memo:"",
            ackRequestedAt:0, ackConfirmed:false
          });
          patientName.value=""; guardianName.value=""; hideErr();
          selectedId=ref.id;
        }catch(e){showErr("환자 추가 실패: "+e.message)}
      };

      // 상태 버튼 구성
      const row1=document.getElementById('row1');
      const row2=document.getElementById('row2');
      const row3=document.getElementById('row3');
      const mk=(t,fn,cls="btn")=>{const b=document.createElement('button');b.className=cls;b.textContent=t;b.onclick=fn;if(t==="상담대기중"||t==="면회대기중"){b.style.color="#dc2626";b.style.fontWeight="900"}return b}

      const ROW1=["상담대기중","면회대기중","원내","라운지","외출"];
      const ROW2=["라운지콜완료","외출콜완료","귀가","수납후미귀가"];
      const ROW3=["1진료실","2진료실","3진료실","4진료실","삭제"];
      ROW1.forEach(s=>row1.appendChild(mk(s,()=>applyGlobalState(s))));
      ROW2.forEach(s=>row2.appendChild(mk(s,()=>applyGlobalState(s))));
      ROW3.forEach(s=>{ if(s==="삭제")row3.appendChild(mk(s,onDelete,"btn dark")); else row3.appendChild(mk(s,()=>applyGlobalState(s))); });

      // 메모
      const memoInput=document.getElementById('memoInput');
      const memoSaveBtn=document.getElementById('memoSaveBtn');
      memoSaveBtn.onclick=async()=>{ if(!selectedId) return showErr("먼저 환자를 선택하세요."); await updateCase(selectedId,{memo:(memoInput.value||"").trim()}); };

      let selectedId=null;
      const caseList=document.getElementById('caseList');

      function prettyName(d,id){return (d.patientName||d.guardianName)?(d.patientName&&d.guardianName?`${d.patientName}(${d.guardianName})`:(d.patientName||d.guardianName)):id}
      function colorFor(s){
        if(s==="상담대기중"||s==="면회대기중")return"#dc2626";
        if(s==="원내"||s==="라운지")return"#d97706";
        if(s==="외출")return"#0284c7";
        if(s==="라운지콜완료"||s==="외출콜완료")return"#16a34a";
        if(/^\s*[1-4]\s?진료실$/.test(s||""))return"#2b5fa3";
        if(s==="귀가"||s==="수납후미귀가")return"#64748b";
        return"";
      }

      function renderLine(id,d){
        const line=document.createElement('div');line.className='line';line.dataset.id=id;
        const name=document.createElement('div');name.className='name';name.textContent=prettyName(d,id);
        if(d.memo && d.memo.trim()!==""){const m=document.createElement('span');m.textContent="📝";m.style.marginLeft="8px";m.style.fontSize="12px";m.title=d.memo.trim();name.appendChild(m);}
        const state=document.createElement('div');state.className='state';state.textContent=d.location||''; const c=colorFor(d.location||""); if(c)state.style.color=c;
        const upd=document.createElement('div');upd.className='updated'; if(d.updatedAt){upd.dataset.ts=String(d.updatedAt);upd.innerHTML=renderUpdatedText(d.updatedAt)} else upd.textContent='';
        line.appendChild(name);line.appendChild(state);line.appendChild(upd);
        line.onclick=()=>{selectedId=id;[...caseList.children].forEach(el=>el.classList.remove('select'));line.classList.add('select');memoInput.value=d.memo||""};
        if(d.callRequested) line.classList.add('calling');
        return line;
      }

      async function updateCase(id,data){
        try{
          await runTransaction(db,async(tx)=>{
            const ref=doc(db,"cases",id);
            const snap=await tx.get(ref);
            const prev=snap.exists()?snap.data():{version:0};
            tx.set(ref,{...data,updatedAt:Date.now(),version:(prev.version||0)+1},{merge:true});
          });
          hideErr();
        }catch(e){showErr("저장 실패: "+e.message)}
      }

      async function applyGlobalState(state){
        if(!selectedId){showErr("먼저 환자 한 명을 선택하세요.");return;}
        if(state==="귀가"){const yes=confirm("리스트에서 삭제할까요? (예: 문서를 삭제 / 아니오: 상태만 '귀가'로 표시)"); if(yes){return onDelete();}}
        if(state==="상담대기중"||state==="면회대기중"){
          await updateCase(selectedId,{location:state,callRequested:false,ackRequestedAt:Date.now(),ackConfirmed:false});
        }else{
          await updateCase(selectedId,{location:state,callRequested:false});
        }
      }

      async function onDelete(){
        if(!selectedId) return showErr("먼저 환자 한 명을 선택하세요.");
        const ok=confirm("정말 삭제하시겠습니까? (되돌릴 수 없습니다)");
        if(!ok) return;
        try{ await deleteDoc(doc(db,"cases",selectedId)); selectedId=null; hideErr(); memoInput.value=""; }
        catch(e){ showErr("삭제 실패: "+e.message); }
      }

      // ===== 알림 UI =====
      const alertBox=document.getElementById('alertBox');
      const alertWho=document.getElementById('alertWho');
      const ackBtn=document.getElementById('ack');

      const bigOverlay=document.getElementById('bigOverlay');
      const modalTitle=document.getElementById('modalTitle');
      const bigWho=document.getElementById('bigWho');
      const bigAck=document.getElementById('bigAck');
      const bigClose=document.getElementById('bigClose');
      const bell=document.getElementById('bell');

      const relayBox=document.getElementById('relayBox');

      let lastAlertedId=null;
      let pendingReq=null;

      function resolveAckLocation(cur){ if(cur==="외출")return"외출콜완료"; if(cur==="라운지")return"라운지콜완료"; return"라운지콜완료"; }
      function showBigOverlay(name){ bigWho.textContent=name; bigOverlay.classList.add('show'); bigOverlay.setAttribute('aria-hidden','false'); }
      function hideBigOverlay(){ bigOverlay.classList.remove('show'); bigOverlay.setAttribute('aria-hidden','true'); }
      bigClose.onclick=hideBigOverlay;

      // 실시간 구독
      onSnapshot(query(collection(db,"cases"),orderBy("createdAt","desc")),(snap)=>{
        hideErr();
        caseList.innerHTML="";
        let firstId=null;
        let anyReq=null;

        // ▶ 디스플레이 확인 신호(ackConfirmed:true) 감지했는지 추적
        let anyAck=null;

        snap.forEach(docu=>{
          const d=docu.data();
          const el=renderLine(docu.id,d);
          caseList.appendChild(el);
          if(!firstId) firstId=docu.id;

          if(docu.id===selectedId) { /* 현재 선택 유지용 */ }

          if(d.callRequested) anyReq={id:docu.id,d};

          // ★★★ 디스플레이 팝업 '확인' 후 신호 감지 지점 ★★★
          if(d.ackConfirmed===true){
            anyAck={id:docu.id,d};
          }
        });

        // 최초 자동 선택 보정
        if(!selectedId && firstId){
          selectedId=firstId;
          const firstEl=caseList.querySelector(`[data-id="${firstId}"]`);
          if(firstEl) firstEl.classList.add('select');
        }
        if(selectedId){
          const selEl=caseList.querySelector(`[data-id="${selectedId}"]`);
          if(selEl){ [...caseList.children].forEach(el=>el.classList.remove('select')); selEl.classList.add('select'); }
        }

        // 작은 배너: 콜요청 우선, 없으면 전달완료 배너
        if(anyReq){
          alertWho.textContent=prettyName(anyReq.d,anyReq.id);
          alertBox.classList.add('show');
          relayBox.classList.remove('show');
        }else if(anyAck){
          const name=prettyName(anyAck.d,anyAck.id);
          relayBox.textContent=`📣 '${name}' 대기중 전달완료`;
          relayBox.style.display="";
          relayBox.classList.add('show');
          alertBox.classList.remove('show');

          // 사운드 + 자동 숨김 + 플래그 리셋(false)  → 중복 방지
          try{ bell.currentTime=0; bell.play().catch(()=>{});}catch(e){}
          setTimeout(async()=>{
            relayBox.classList.remove('show');
            await updateCase(anyAck.id,{ackConfirmed:false});
          },1500);
        }else{
          alertBox.classList.remove('show');
          relayBox.classList.remove('show');
        }

        // 큰 팝업 + 사운드: 콜요청만 사용(기존 동작 유지)
        if(anyReq && anyReq.id!==lastAlertedId){
          pendingReq=anyReq;
          modalTitle.textContent='📣 콜 요청';
          showBigOverlay(prettyName(anyReq.d,anyReq.id));
          try{ bell.currentTime=0; bell.play().catch(()=>{});}catch(e){}
          lastAlertedId=anyReq.id;
        }
        if(!anyReq){
          pendingReq=null; lastAlertedId=null; hideBigOverlay();
        }

        conn.textContent="연결됨"; conn.className="pill ok";
      },(e)=>{conn.textContent="연결 오류";conn.className="pill err";showErr("리스트 구독 실패: "+e.message);});

      // 콜요청 처리완료(기존)
      async function acknowledge(req){
        if(!req) return;
        const d=req.d;
        const ns=resolveAckLocation(d.location||"");
        await updateCase(req.id,{callRequested:false,location:ns});
        hideBigOverlay();
      }
      ackBtn.onclick=()=>acknowledge(pendingReq);
      bigAck.onclick=()=>acknowledge(pendingReq);

      // 연결 테스트
      selftest.onclick=async()=>{
        try{ await setDoc(doc(db,"healthcheck","reception"),{ping:Date.now()},{merge:true});
          conn.textContent="연결 정상"; conn.className="pill ok"; hideErr();
        }catch(e){ conn.textContent="연결 오류"; conn.className="pill err"; showErr("연결 테스트 실패: "+e.message); }
      };

    }catch(e){
      showErr("Firebase 초기화 실패: "+(e.message||e));
      const conn=document.getElementById('conn'); if(conn){conn.textContent="초기화 오류";conn.className="pill err";}
    }
  </script>
</body>
</html>
