<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>Clinic-flow (ë‚´ë¶€ìš©)</title>
  <style>
    :root{
      --bg:#0b1220; --fg:#ffffff; --muted:#9ca3af;
      --card:#111827cc; --border:#1f2937; --blur:8px;
      --brand:#2b5fa3;
      --s-red:#dc2626; --s-amber:#d97706; --s-sky:#0284c7; --s-green:#111827; --s-gray:#64748b;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .topbar{
      position:fixed; inset:0 0 auto 0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 14px; background:var(--card); border-bottom:1px solid var(--border); backdrop-filter:blur(var(--blur));
      font-size:12px;
    }
    .brandwrap{display:flex; align-items:center; gap:10px; font-weight:900}
    .logo{width:22px;height:22px;border-radius:5px;object-fit:cover}
    .brand{letter-spacing:.2px}
    .right{display:flex;align-items:center;gap:8px}
    .whoami{opacity:.8}
    .tbtn{cursor:pointer;border:0;border-radius:8px;padding:6px 8px;background:#1f2937;color:#fff;border:1px solid #374151}
    .tbtn.ok{background:var(--brand);border-color:transparent}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;font-weight:800;background:#1f2937;border:1px solid #374151}
    .pill.ok{background:#111827}.pill.err{background:#dc2626}.pill.warn{background:#f59e0b;color:#111}

    .wrap{min-height:100%;padding:64px 14px 20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:14px; display:flex; flex-direction:column; gap:10px;
    }
    /* ì½œìš”ì²­ = ê³ ì • í…Œë‘ë¦¬(ë¬´í•œ ì ë©¸ ì œê±°) */
    .card.call{outline:4px solid rgba(220,38,38,.6); outline-offset:-4px; animation:none;}

    @keyframes call{0%,100%{outline-color:rgba(220,38,38,.2)}50%{outline-color:rgba(220,38,38,.8)}}

    /* ğŸ”” ìƒë‹´/ë©´íšŒ/ë©”ëª¨ ì‹ ê·œì‹œ 5~6ì´ˆ ë¶‰ì€ í…Œë‘ë¦¬ */
    .card.flash5{
      outline:4px solid rgba(220,38,38,.8);
      outline-offset:-4px;
    }

    .head{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .name{font-weight:900; font-size:18px; word-break:keep-all}
    .badge{
      border-radius:999px; padding:6px 10px; font-weight:900; font-size:12px; white-space:nowrap;
      border:1px solid #374151; background:#1f2937; color:#fff;
    }
    .b-ìƒë‹´ëŒ€ê¸°ì¤‘{background:var(--s-red); border-color:transparent}
    .b-ë©´íšŒëŒ€ê¸°ì¤‘{background:var(--s-red); border-color:transparent; color:#fff;}
    .b-ì›ë‚´,.b-ë¼ìš´ì§€{background:#FFD9DF; color:#111; border-color:transparent}
    .b-ì™¸ì¶œ{background:#C084FC; color:#111; border-color:transparent}
    .b-ë¼ìš´ì§€ì½œì™„ë£Œ,.b-ì™¸ì¶œì½œì™„ë£Œ{background:#34D399; border-color:transparent}
    .b-ê·€ê°€,.b-ìˆ˜ë‚©í›„ë¯¸ê·€ê°€{background:#9CA3AF; color:#111; border-color:transparent}
    .b-1ì§„ë£Œì‹¤,.b-2ì§„ë£Œì‹¤,.b-3ì§„ë£Œì‹¤,.b-4ì§„ë£Œì‹¤{ background:#2b5fa3; color:#fff; border-color:transparent; }

    .memo{
      display:none; font-size:14px; line-height:1.25; font-weight:800;
      color:#111; background:#FFF176; border:1px solid #f59e0b;
      padding:5px 8px; border-radius:10px; display:inline-block; align-self:flex-start;
      max-width:100%; overflow-wrap:anywhere;
    }
    .memo.show{ display:inline-block; }
    .meta{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{cursor:pointer; border:0; border-radius:10px; padding:8px 12px; font-size:13px; font-weight:700;
      background:#1f2937; color:#fff; border:1px solid #374151;}
    .btn.ghost{background:transparent; color:#9ca3af}

    .errbox{display:none;background:#fee2e2;color:#7f1d1d;border:2px solid #ef4444;border-radius:12px;padding:10px 12px;margin:8px 0;font-weight:700;white-space:pre-wrap}
    .errbox.show{display:block}

    .overlay{position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,.65); backdrop-filter:blur(4px)}
    .overlay.show{display:flex}
    .modal{width:min(720px,92vw); background:#fff; color:#0f172a; border-radius:16px; border:3px solid #ef4444; box-shadow:0 20px 60px rgba(0,0,0,.35); padding:22px; text-align:center; animation:flash .9s ease-in-out 1}
    @keyframes flash{0%{transform:scale(.98)}100%{transform:scale(1)}}
    .modal h2{margin:0 0 6px; font-size:24px; font-weight:600}
    .who{font-size:40px; font-weight:900; margin:6px 0 2px}
    .hint{font-size:13px; color:#64748b; margin-bottom:14px}
    .m-actions{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px}
    .m-actions .btn{padding:12px 16px; font-size:15px}
    .m-close{position:absolute; top:10px; right:12px; background:transparent; color:#fff; border:0; font-size:24px; cursor:pointer}

    .emoji{font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla","Segoe UI Symbol",sans-serif; font-weight:400; line-height:1; vertical-align:-2px;}

    .modal h2{font-weight:800; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; text-rendering:optimizeLegibility;}
    .modal{will-change:transform; transform:translateZ(0);}
    .btn.ghost{ background:#1f2937; border:1px solid #4b5563; opacity:.9 }
    .btn.ghost:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brandwrap">
      <img class="logo" src="image-512.png" alt="BS Logo" />
      <div class="brand">BS ë³´í˜¸ì ëª¨ë‹ˆí„° (ë‚´ë¶€ìš©)</div>
    </div>
    <div class="right">
      <span id="whoami" class="whoami"></span>
      <button id="loginBtn" class="tbtn ok">Google ë¡œê·¸ì¸</button>
      <button id="logoutBtn" class="tbtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="soundBtn" class="tbtn" title="ì†Œë¦¬: ì¼¬" aria-pressed="true">ğŸ”Š</button>
      <span id="conn" class="pill warn">ì—°ê²° í™•ì¸ ì¤‘â€¦</span>
    </div>
  </div>

  <div class="wrap">
    <div id="err" class="errbox"></div>
    <div id="grid" class="grid"></div>
  </div>

  <audio id="ding" src="ding.mp3" preload="auto"></audio>

  <div id="ackOverlay" class="overlay" aria-hidden="true">
    <button id="ackClose" class="m-close" title="ë‹«ê¸°">âœ•</button>
    <div class="modal" role="dialog" aria-modal="true">
     <h2><span class="emoji">ğŸ“£</span> ëŒ€ê¸° í™˜ì í™•ì¸</h2>
      <div id="ackWho" class="who"></div>
      <div class="hint">â€œí™•ì¸â€ì„ ëˆ„ë¥´ë©´ ë¦¬ì…‰ì— â€˜ëŒ€ê¸°ì¤‘ ì „ë‹¬ì™„ë£Œâ€™ë¡œ ì•ˆë‚´ë©ë‹ˆë‹¤. ("ë³´ë¥˜"ë¥¼ ëˆ„ë¥´ë©´ ì´ ì»´í“¨í„°ì—ì„œì˜ íŒì—…ì°½ë§Œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.) </div>
      <div class="m-actions">
        <button id="ackHold" class="btn ghost">ë³´ë¥˜</button>
        <button id="ackConfirm" class="btn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script type="module">
    const grid=document.getElementById('grid');
    const conn=document.getElementById('conn');
    const ding=document.getElementById('ding');
    const errBox=document.getElementById('err');
    const whoami=document.getElementById('whoami');
    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');

    // ===== ì†Œë¦¬/ì•Œë¦¼ í† ê¸€ & í†µí•© ìš¸ë¦¼ ìœ í‹¸ =====
const soundBtn = document.getElementById('soundBtn');

function isHidden(){ return document.hidden === true; }
function isSoundOn(){
  try{ return localStorage.getItem('soundOn') !== '0'; }catch(e){ return true; } // ê¸°ë³¸: ì¼¬
}
function setSound(on){
  try{ localStorage.setItem('soundOn', on ? '1' : '0'); }catch(e){}
  updateSoundUI();
}
function updateSoundUI(){
  const on = isSoundOn();
  if(!soundBtn) return;
  soundBtn.textContent = on ? 'ğŸ”Š' : 'ğŸ”‡';
  soundBtn.title = on ? 'ì†Œë¦¬: ì¼¬' : 'ì†Œë¦¬: ë”';
  soundBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
}

function canSystemNotify(){ return 'Notification' in window; }
async function ensureNotifyPermissionIfNeeded(){
  if(!canSystemNotify()) return false;
  // ê¶Œí•œì´ ì—†ëŠ”ë° ì°½ì´ ìˆ¨ê¹€ ìƒíƒœë©´ ì‹œìŠ¤í…œ ì•Œë¦¼ì´ ë§‰í˜€ì„œ ìš¸ë¦¬ì§€ ì•Šì„ ìˆ˜ ìˆìŒ â†’ ë¯¸ë¦¬ ìš”ì²­
  if(Notification.permission === 'granted') return true;
  if(Notification.permission === 'denied') return false;
  const res = await Notification.requestPermission();
  return res === 'granted';
}

/** ì†Œë¦¬/ì•Œë¦¼ í†µí•© ìš¸ë¦¼
 * - ì¼¬(ğŸ”Š)ì¼ ë•Œë§Œ ë™ì‘
 * - ë³´ì´ëŠ” ì¤‘: ding.mp3 ì¬ìƒ
 * - ìˆ¨ê¹€/ìµœì†Œí™”: ding ì¬ìƒ + ì‹œìŠ¤í…œ ì•Œë¦¼(ìœˆë„ìš° ê¸°ë³¸ íš¨ê³¼ìŒ ê¸°ëŒ€)
 */
async function ringWithFallback(title, body, tag='bs-owner-monitor'){
  if(!isSoundOn()) return; // ğŸ”‡ì´ë©´ ë¬´ìŒ
  // 1) ì‚¬ìš´ë“œ ì‹œë„
  try{ ding.currentTime = 0; await ding.play(); }catch(e){ /* ë¸Œë¼ìš°ì € ì •ì±…ì— ë”°ë¼ ë¬´ì‹œë  ìˆ˜ ìˆìŒ */ }

  // 2) ìˆ¨ê¹€(ë°±ê·¸ë¼/ìµœì†Œí™”)ì¼ ë•Œ ì‹œìŠ¤í…œ ì•Œë¦¼ë„
  if(isHidden() && canSystemNotify()){
    const ok = await ensureNotifyPermissionIfNeeded();
    if(ok){
      new Notification(title, {
        body, tag, renotify:true, requireInteraction:true, timestamp:Date.now(), silent:false
      });
    }
  }
}

// í† ê¸€ ë²„íŠ¼ í´ë¦­
if (soundBtn){
  soundBtn.onclick = async ()=>{
    const next = !isSoundOn();
    setSound(next);
    // ì¼¬ìœ¼ë¡œ ë°”ê¾¸ëŠ” ìˆœê°„, ìµœì†Œí™” ëŒ€ì‘ ìœ„í•´ ê¶Œí•œ ë¯¸ë¦¬ í™•ë³´ ì‹œë„(ê±°ë¶€í•´ë„ ë™ì‘ì€ ìœ ì§€)
    if(next && canSystemNotify() && Notification.permission !== 'granted'){
      await ensureNotifyPermissionIfNeeded();
      updateSoundUI();
    }
  };
  // ì´ˆê¸° UI ë™ê¸°í™”
  updateSoundUI();
}
// ë¸Œë¼ìš°ì € ì‹œì‘ ì‹œ ê¶Œí•œì´ ì´ë¯¸ grantedë©´ ê·¸ëŒ€ë¡œ, ì•„ë‹ˆë©´ ë‚˜ì¤‘ì— ring ì‹œ ìš”ì²­

    
    // ---- Device name resolve & persist ----
    function resolveDeviceName(){
      try{
        const KEY='deviceName';
        let n=localStorage.getItem(KEY);
        if(!n){
          const guess=(navigator.userAgentData?.platform||navigator.platform||'').replace(/\s+/g,'-');
          n=prompt('ì´ ë””ìŠ¤í”Œë ˆì´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ëŒ€ê¸°ì‹¤-ëª¨ë‹ˆí„°)', guess || '');
          if(n) localStorage.setItem(KEY, n);
        }
        return n || 'ë””ìŠ¤í”Œë ˆì´';
      }catch(e){ return 'ë””ìŠ¤í”Œë ˆì´'; }
    }
    const DEVICE_NAME = resolveDeviceName();

    
    const showErr=(m)=>{console.error(m);errBox.textContent=m;errBox.classList.add('show')};
    const hideErr=()=>errBox.classList.remove('show');

    const relTime=(ts)=>{if(!ts)return "";const s=Math.floor((Date.now()-ts)/1000);
      if(s<60)return`${s}ì´ˆ ì „`;const m=Math.floor(s/60);if(m<60)return`${m}ë¶„ ì „`;
      const h=Math.floor(m/60);if(h<24)return`${h}ì‹œê°„ ì „`;const d=Math.floor(h/24);return`${d}ì¼ ì „`};
    const formatKTime=(ts)=>{if(!ts)return"";const d=new Date(ts);let h=d.getHours();const m=String(d.getMinutes()).padStart(2,"0");const ap=h<12?"ì˜¤ì „":"ì˜¤í›„";h=h%12||12;return`${ap} ${h}:${m}`};

    setInterval(()=>{document.querySelectorAll('[data-updated]').forEach(el=>{
      const ts=Number(el.dataset.updated||0);
      el.textContent = ts ? `ì—…ë°ì´íŠ¸: ${relTime(ts)} (${formatKTime(ts)})` : '';
    });},30_000);

    const isClinic=(s)=>/^[1-4]\s?ì§„ë£Œì‹¤$/.test((s||'').trim());
    const badgeClass=(s)=>({
      'ìƒë‹´ëŒ€ê¸°ì¤‘':'b-ìƒë‹´ëŒ€ê¸°ì¤‘','ë©´íšŒëŒ€ê¸°ì¤‘':'b-ë©´íšŒëŒ€ê¸°ì¤‘',
      'ì›ë‚´':'b-ì›ë‚´','ë¼ìš´ì§€':'b-ë¼ìš´ì§€','ì™¸ì¶œ':'b-ì™¸ì¶œ',
      'ë¼ìš´ì§€ì½œì™„ë£Œ':'b-ë¼ìš´ì§€ì½œì™„ë£Œ','ì™¸ì¶œì½œì™„ë£Œ':'b-ì™¸ì¶œì½œì™„ë£Œ',
      'ê·€ê°€':'b-ê·€ê°€','ìˆ˜ë‚©í›„ë¯¸ê·€ê°€':'b-ìˆ˜ë‚©í›„ë¯¸ê·€ê°€',
      '1 ì§„ë£Œì‹¤':'b-1ì§„ë£Œì‹¤','2 ì§„ë£Œì‹¤':'b-2ì§„ë£Œì‹¤','3 ì§„ë£Œì‹¤':'b-3ì§„ë£Œì‹¤','4 ì§„ë£Œì‹¤':'b-4ì§„ë£Œì‹¤',
      '1ì§„ë£Œì‹¤':'b-1ì§„ë£Œì‹¤','2ì§„ë£Œì‹¤':'b-2ì§„ë£Œì‹¤','3ì§„ë£Œì‹¤':'b-3ì§„ë£Œì‹¤','4ì§„ë£Œì‹¤':'b-4ì§„ë£Œì‹¤'
    }[s]||'');

    let auth, provider, db;

    const ackOverlay = document.getElementById('ackOverlay');
    const ackWho     = document.getElementById('ackWho');
    const ackConfirm = document.getElementById('ackConfirm');
    const ackClose   = document.getElementById('ackClose');
    const ackHold    = document.getElementById('ackHold');

    const holdKey = (id, reqAt)=> `ackHold:${id}:${Number(reqAt||0)}`;

    let modalTargetId = null;
    let modalTargetReqAt = 0;
    const lastSeenReqAt = new Map();

    function openAck(name, id, reqAt){
      modalTargetId = id;
      modalTargetReqAt = Number(reqAt||0);
      ackWho.textContent = name;
      ackOverlay.classList.add('show');
      ackOverlay.setAttribute('aria-hidden','false');
      ringWithFallback('ëŒ€ê¸° í™˜ì í™•ì¸', `${name} í™•ì¸ í•„ìš”`, 'ack-popup');
    }
    function closeAck(){
      ackOverlay.classList.remove('show');
      ackOverlay.setAttribute('aria-hidden','true');
    }

    /* ğŸ”” 5~6ì´ˆ ë¶‰ì€ í…Œë‘ë¦¬ ìœ ì§€ (ìƒë‹´/ë©´íšŒ/ë©”ëª¨ ì‹ ê·œ) */
    function flashSolidById(id, ms=5600){
      const el = document.querySelector(`.card[data-id="${id}"]`);
      if(!el) return;
      el.classList.add('flash5');
      setTimeout(()=> el.classList.remove('flash5'), ms);
    }

        try{
      const { initializeApp }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
      const { getFirestore, collection, onSnapshot, query, orderBy, runTransaction, doc }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const { getAuth, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut }=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

      const firebaseConfig={apiKey:"AIzaSyDh_LCBSgYZX1nnz3C-kGzjVtIwI3zf_8g",authDomain:"clinic-flow-c26f6.firebaseapp.com",projectId:"clinic-flow-c26f6"};
      const app=initializeApp(firebaseConfig);
      db=getFirestore(app);

      auth=getAuth(app);
      await setPersistence(auth, browserLocalPersistence).catch(e=>showErr('Persistence ì„¤ì • ì‹¤íŒ¨: '+e.message));
      provider=new GoogleAuthProvider();
      getRedirectResult(auth).catch(e=>showErr('ë¦¬ë‹¤ì´ë ‰íŠ¸ ê²°ê³¼ ì˜¤ë¥˜: '+e.message));

      async function doLogin(){
        try{ await signInWithPopup(auth, provider); }
        catch(e){
          if(e?.code==='auth/operation-not-supported-in-this-environment' || String(e?.message||'').includes('popup')){
            showErr('íŒì—… ë¡œê·¸ì¸ ë¶ˆê°€ â†’ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œê·¸ì¸ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
            await signInWithRedirect(auth, provider);
            return;
          }
          showErr('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+(e.code||'')+' '+e.message);
        }
      }
      loginBtn.onclick=doLogin;
      logoutBtn.onclick=async()=>{ try{ await signOut(auth); }catch(e){ showErr('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: '+e.message);} };
      onAuthStateChanged(auth,(user)=>{
        if(user){ whoami.textContent = user.email ? `${user.email} Â· ${DEVICE_NAME}` : DEVICE_NAME; logoutBtn.style.display=''; loginBtn.style.display='none'; }
        else{ whoami.textContent=''; logoutBtn.style.display='none'; loginBtn.style.display=''; }
      });

      onSnapshot(query(collection(db,"cases"),orderBy("createdAt","desc")),(snap)=>{
        hideErr();

        const docs = snap.docs.map(x=>({ id:x.id, ...x.data() }));
        const byId = new Map(docs.map(d=>[d.id,d]));

        // ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ í™•ì¸ë˜ë©´ í˜„ì¬ íŒì—… ë‹«ê¸°
        if (modalTargetId) {
          const fresh = byId.get(modalTargetId);
          if (fresh) {
            const reqAt = Number(fresh.ackRequestedAt||0);
            if (fresh.ackConfirmed === true) {
              lastSeenReqAt.set(modalTargetId, reqAt);
              closeAck();
              modalTargetId = null;
            }
          }
        }

        // ìƒˆ ìš”ì²­ íƒì§€ â†’ íŒì—… (ìƒë‹´/ë©´íšŒë§Œ)
        if (!modalTargetId) {
          const cands = docs.filter(d=>{
            const s=d.location||'';
            const reqAt = Number(d.ackRequestedAt||0);
            const seen  = lastSeenReqAt.get(d.id)||0;
            const held = (function(){ try{ return localStorage.getItem(holdKey(d.id, reqAt))==='1'; }catch(e){ return false; } })();
            return (s==="ìƒë‹´ëŒ€ê¸°ì¤‘"||s==="ë©´íšŒëŒ€ê¸°ì¤‘") && reqAt>0 && !d.ackConfirmed && reqAt>seen && !held;
          });
          if (cands.length){
            cands.sort((a,b)=>(a.ackRequestedAt||0)-(b.ackRequestedAt||0));
            const p = cands[0];
            const nm = (p.patientName||p.guardianName)
              ? (p.patientName && p.guardianName ? `${p.patientName}(${p.guardianName})` : (p.patientName||p.guardianName)) : p.id;
            openAck(nm, p.id, p.ackRequestedAt);
          }
        }

        // ì¹´ë“œ ë Œë” ë° ì•Œë¦¼ íŠ¸ë¦¬ê±° ê³„ì‚° ì¤€ë¹„
        const frag=document.createDocumentFragment();
        if(!window._prevState){ window._prevState=new Map(); window._prevHasMemo=new Map(); window._lastCall=new Set(); window._inited=false; }
        const prevState=window._prevState, prevHasMemo=window._prevHasMemo, lastCall=window._lastCall, inited=window._inited;

        // ì •ë ¬ ìš°ì„ ìˆœìœ„
        docs.sort((a,b)=>{
          const rank=(d)=>{
            const s=d.location||'';
            if(s==="ìƒë‹´ëŒ€ê¸°ì¤‘" || s==="ë©´íšŒëŒ€ê¸°ì¤‘") return 0;
            if(/^[1-4]\s?ì§„ë£Œì‹¤$/.test(s)) return 1;
            if(s==="ê·€ê°€"||s==="ìˆ˜ë‚©í›„ë¯¸ê·€ê°€") return 3;
            return 2;
          };
          const oa=rank(a), ob=rank(b);
          if(oa!==ob) return oa-ob;
          return (b.createdAt||0)-(a.createdAt||0);
        });

        const toFlashSolid = []; // âœ… ì´ë²ˆ í”„ë ˆì„ì—ì„œ 5~6ì´ˆ ë¶‰ì€ í…Œë‘ë¦¬ ì¤„ ëŒ€ìƒ
        docs.forEach(d=>{
          let shouldDing=false;
          const curState=d.location||"";
          const curHasMemo=!!((d.memo||"").trim());

          if(inited){
            if(d.callRequested && !lastCall.has(d.id)) shouldDing=true;                   // ì½œ ìƒˆë¡œ ì¼œì§
            const ps=prevState.get(d.id);
            if((curState==="ìƒë‹´ëŒ€ê¸°ì¤‘"||curState==="ë©´íšŒëŒ€ê¸°ì¤‘") && curState!==ps) shouldDing=true; // ìƒë‹´/ë©´íšŒ ì§„ì…
            const pm=prevHasMemo.get(d.id);
            if(curHasMemo && !pm) shouldDing=true;                                       // ë©”ëª¨ ì‹ ê·œ
          }

          // ì½œìš”ì²­ ì§‘í•© ê°±ì‹ 
          if(d.callRequested) lastCall.add(d.id); else lastCall.delete(d.id);

          // ğŸ”” ì†Œë¦¬ íŠ¸ë¦¬ê±°ê°€ ë‚¬ê³ , "ì½œ ìƒˆë¡œ ì¼œì§"ì´ ì•„ë‹Œ ê²½ìš° â†’ 5~6ì´ˆ ë¶‰ì€ í…Œë‘ë¦¬
          const isNewCall = (d.callRequested && !inited && false) || (d.callRequested && !prevState.has(d.id)) ? false
                            : (d.callRequested && !window._lastCall.has(d.id)); // ë³´í˜¸ì  ê³„ì‚°
          // ìœ„ í•œ ì¤„ì€ ë°©ì–´ì ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì•„ë˜ì²˜ëŸ¼ ê°„ë‹¨íˆ:
          // const isNewCall = (d.callRequested && !window._lastCall.has(d.id));

          if(shouldDing){
            // ìƒˆ ì½œì´ ì•„ë‹ˆë¼ë©´(= ìƒë‹´/ë©´íšŒ ì§„ì… ë˜ëŠ” ë©”ëª¨ ì‹ ê·œ), ì ì‹œ ë¶‰ì€ í…Œë‘ë¦¬
            const newCallNow = (d.callRequested && !window._lastCall.has(d.id));
            if(!newCallNow){
              toFlashSolid.push(d.id);
            }
            const nm = (d.patientName||d.guardianName)
  ? (d.patientName && d.guardianName ? `${d.patientName}(${d.guardianName})` : (d.patientName||d.guardianName))
  : d.id;
const state = (d.location||'ìƒíƒœë³€ê²½');
ringWithFallback('ìƒíƒœ ì•Œë¦¼', `${nm}: ${state}`, 'case-update');

          }

          prevState.set(d.id,curState);
          prevHasMemo.set(d.id,curHasMemo);

          // === ì¹´ë“œ DOM ===
          const card=document.createElement('div');
          card.className='card';
          card.dataset.id = d.id;                             // âœ… í…Œë‘ë¦¬ ì ìš©ì„ ìœ„í•œ data-id
          if(d.callRequested) card.classList.add('call');     // ì½œìš”ì²­ ê³ ì • í…Œë‘ë¦¬

          const head=document.createElement('div');head.className='head';
          const name=document.createElement('div');name.className='name';
          name.textContent=(d.patientName||d.guardianName)
            ?(d.patientName&&d.guardianName?`${d.patientName}(${d.guardianName})`:(d.patientName||d.guardianName))
            :d.id;
          const badge=document.createElement('span');badge.className='badge '+(badgeClass(curState)||''); badge.textContent=curState||'ìƒíƒœì—†ìŒ';
          head.appendChild(name); head.appendChild(badge);
          card.appendChild(head);

          const memoTxt=(d.memo||"").trim();
          if(memoTxt){
            const memo=document.createElement('div');memo.className='memo show';
            memo.textContent=memoTxt.length>140?memoTxt.slice(0,137)+'â€¦':memoTxt;
            card.appendChild(memo);
          }

          const meta=document.createElement('div');meta.className='meta';
          meta.dataset.updated=d.updatedAt||0;
          meta.textContent=d.updatedAt?`ì—…ë°ì´íŠ¸: ${relTime(d.updatedAt)} (${formatKTime(d.updatedAt)})`:'';
          card.appendChild(meta);

          const actions=document.createElement('div');actions.className='actions';
          const callBtn=document.createElement('button');callBtn.className='btn';callBtn.textContent='ğŸ“£ ì½œìš”ì²­í•˜ê¸°';
          const cancelBtn=document.createElement('button');cancelBtn.className='btn ghost';cancelBtn.textContent='ì½œìš”ì²­ì·¨ì†Œ';
        callBtn.onclick=()=> requireLoginThen(()=>updateCase(d.id,{callRequested:true,callRequestedAt:Date.now(),callRequestedBy:DEVICE_NAME}));
          cancelBtn.onclick=()=> requireLoginThen(()=>updateCase(d.id,{callRequested:false}));
          actions.appendChild(callBtn);actions.appendChild(cancelBtn);
          card.appendChild(actions);

          frag.appendChild(card);
        });

        const gridEl=document.getElementById('grid');
        gridEl.innerHTML='';
        gridEl.appendChild(frag);

        // âœ… ë Œë” ì™„ë£Œ í›„, ìƒë‹´/ë©´íšŒ/ë©”ëª¨ ì‹ ê·œì˜€ë˜ ì¹´ë“œë“¤ë§Œ 5~6ì´ˆ ë¶‰ì€ í…Œë‘ë¦¬
        requestAnimationFrame(()=>{
          toFlashSolid.forEach(id => flashSolidById(id));
        });

        window._inited=true;
        conn.textContent='ì—°ê²°ë¨'; conn.className='pill ok';
      },(e)=>{conn.textContent='ì—°ê²° ì˜¤ë¥˜';conn.className='pill err';showErr('ë¦¬ìŠ¤íŠ¸ êµ¬ë… ì‹¤íŒ¨: '+e.message);});

      function requireLoginThen(fn){
        if(auth.currentUser){ fn(); return; }
        showErr('ì´ ì‘ì—…ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ ì°½ì„ ì—´ê²Œìš”.');
        doLogin();
      }

      async function updateCase(id,data){
        try{
          await runTransaction(db,async(tx)=>{
            const ref=doc(db,"cases",id);
            const snap=await tx.get(ref);
            const prev=snap.exists()?snap.data():{version:0};
            tx.set(ref,{...data,updatedAt:Date.now(),version:(prev.version||0)+1},{merge:true});
          });
        }catch(e){ throw e; }
      }

      // â–¶ íŒì—… ë²„íŠ¼: â€˜í™•ì¸â€™ì€ ì „ì†¡, â€˜ë³´ë¥˜/Xâ€™ëŠ” ë‹¨ìˆœ ë‹«ê¸°
     async function confirmAckAndClose(){
        if(!modalTargetId) return;
        try{
   await updateCase(modalTargetId,{ ackConfirmed:true, ackDevice: DEVICE_NAME, ackAt: Date.now(), ackResolvedAt: Date.now() });

          lastSeenReqAt.set(modalTargetId, modalTargetReqAt||Date.now());
          closeAck();
          modalTargetId=null;
        }catch(e){
          showErr('í™•ì¸ ì „ì†¡ ì‹¤íŒ¨: '+(e.code||'')+' '+e.message);
        }
      }
      // í™•ì¸ = ì „ì†¡
      ackConfirm.onclick = ()=> requireLoginThen(confirmAckAndClose);
      // ë³´ë¥˜ = ë‹¨ìˆœ ë‹«ê¸°
      ackHold.onclick    = ()=>{
        try{
          if(modalTargetId && modalTargetReqAt){
            localStorage.setItem(holdKey(modalTargetId, modalTargetReqAt), '1');
          }
        }catch(e){}
        closeAck();
        modalTargetId=null;
      };
      // X = ë³´ë¥˜ì™€ ë™ì¼
      ackClose.onclick   = ()=>{
        closeAck();
        modalTargetId=null;
      };

    }catch(e){
      conn.textContent='ì´ˆê¸°í™” ì˜¤ë¥˜';conn.className='pill err';
      showErr('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: '+(e.message||e));
    }
  </script>
</body>
</html>

